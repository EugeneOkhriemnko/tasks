<template>
  <div class="vc-table-wrapper vc-flex vc-flex-column vc-flex-grow_1">
    <slot name="header" v-if="items && items.length">
      <div
        class="
          vc-table__header
          vc-flex-shrink_0
          vc-flex
          vc-flex-align_center
          vc-flex-justify_space-between
          vc-padding_l
        "
      >
        <vc-input
          class="vc-flex-grow_1"
          :placeholder="searchPlaceholder"
          :clearable="true"
          @change="$emit('searchValueChanged', $event)"
        ></vc-input>
      </div>
    </slot>

    <div class="vc-table-wrapper__inner">
      <vc-loading :active="loading"></vc-loading>
      <vc-container
        v-if="items && items.length"
        ref="scrollContainer"
        :noPadding="true"
        class="vc-flex-grow_1"
      >
        <table
          class="vc-table vc-fill_width"
          :class="{
            'vc-table_empty': !items || !items.length,
            'vc-table_multiselect': multiselect,
          }"
        >
          <thead v-if="columns" class="vc-table__header">
            <tr class="vc-table__header-row">
              <th v-if="multiselect" class="vc-table__header-cell" width="50">
                <div
                  class="vc-flex vc-flex-justify_center vc-flex-align_center"
                >
                  <vc-checkbox
                    v-model="headerCheckbox"
                    @click.stop
                  ></vc-checkbox>
                </div>
              </th>
              <th
                v-for="item in columns"
                :key="item.id"
                class="vc-table__header-cell vc-padding-horizontal_m"
                :class="{
                  'vc-table__header-cell_sortable': item.sortable,
                }"
                :width="item.width"
                @click="$emit('headerClick', item)"
              >
                <div
                  class="vc-flex vc-flex-align_center vc-flex-nowrap"
                  :class="`vc-flex-justify_${item.align || 'start'}`"
                >
                  <div>
                    <slot :name="`header_${item.id}`">{{ item.title }}</slot>
                  </div>
                  <div
                    v-if="sortField === item.id"
                    class="vc-table__header-cell_sort vc-margin-left_xs"
                  >
                    <vc-icon
                      size="xs"
                      :icon="`fas fa-caret-${
                        sortDirection === 'DESC' ? 'down' : 'up'
                      }`"
                    ></vc-icon>
                  </div>
                </div>
              </th>
            </tr>
          </thead>

          <tbody v-if="items" class="vc-table__body">
            <tr
              v-for="(item, i) in items"
              :key="item.id"
              class="vc-table__body-row"
              :class="{
                'vc-table__body-row_even': i % 2 === 1,
              }"
              @click="$emit('itemClick', item)"
            >
              <td v-if="multiselect" class="vc-table__body-cell" width="50">
                <div
                  class="vc-flex vc-flex-justify_center vc-flex-align_center"
                >
                  <vc-checkbox
                    v-model="checkboxes[item.id]"
                    @click.stop
                  ></vc-checkbox>
                </div>
              </td>
              <td
                v-for="cell in columns"
                :key="`${item.id}_${cell.id}`"
                class="vc-table__body-cell vc-padding-horizontal_m"
                :class="cell.class"
                :width="cell.width"
              >
                <div class="vc-flex vc-flex-align_center">
                  <slot :name="`item_${cell.id}`" :item="item">{{
                    (cell.field || cell.id)
                      .split(".")
                      .reduce((p, c) => (p && p[c]) || null, item)
                  }}</slot>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </vc-container>
      <slot v-else name="empty">
        <div
          v-if="empty"
          class="
            vc-fill_all
            vc-flex vc-flex-column
            vc-flex-align_center
            vc-flex-justify_center
          "
        >
          <img v-if="empty.image" :src="empty.image" />
          <div class="vc-margin_l vc-table__empty-text">{{ empty.text }}</div>
          <vc-button v-if="empty.action" @click="empty.clickHandler">
            {{ empty.action }}
          </vc-button>
        </div>
      </slot>
    </div>

    <slot name="footer" v-if="items && items.length">
      <div
        class="
          vc-table__footer
          vc-flex-shrink_0
          vc-flex
          vc-flex-align_center
          vc-flex-justify_space-between
          vc-padding_l
        "
      >
        <vc-pagination
          :expanded="expanded"
          :pages="pages"
          :currentPage="currentPage"
          @itemClick="$emit('paginationClick', $event)"
        ></vc-pagination>
        <vc-table-counter
          :label="totalLabel"
          :value="totalCount"
        ></vc-table-counter>
      </div>
    </slot>
  </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import VcIcon from "../../atoms/vc-icon/vc-icon.vue";
import VcCheckbox from "../../atoms/vc-checkbox/vc-checkbox.vue";
import VcContainer from "../../atoms/vc-container/vc-container.vue";
import VcInput from "../../molecules/vc-input/vc-input.vue";
import VcPagination from "../../molecules/vc-pagination/vc-pagination.vue";
import VcLoading from "../../atoms/vc-loading/vc-loading.vue";
import VcTableCounter from "./_internal/vc-table-counter/vc-table-counter.vue";

export default defineComponent({
  name: "VcTable",

  components: {
    VcIcon,
    VcCheckbox,
    VcContainer,
    VcInput,
    VcPagination,
    VcTableCounter,
    VcLoading,
  },

  data() {
    const checkboxes: Record<string, boolean> = {};

    return {
      checkboxes,
    };
  },

  props: {
    columns: {
      type: Array,
      default: () => [],
    },

    items: {
      type: Array,
      default: () => [],
    },

    sort: {
      type: String,
      default: undefined,
    },

    multiselect: {
      type: Boolean,
      default: false,
    },

    expanded: {
      type: Boolean,
      default: false,
    },

    totalLabel: {
      type: String,
      default: "Totals:",
    },

    totalCount: {
      type: Number,
      default: 0,
    },

    pages: {
      type: Number,
      default: 0,
    },

    currentPage: {
      type: Number,
      default: 0,
    },

    searchPlaceholder: {
      type: String,
      default: "Search...",
    },

    loading: {
      type: Boolean,
      default: false,
    },

    empty: {
      type: Object,
      default: () => ({}),
    },
  },

  emits: ["paginationClick"],

  watch: {
    items(value: { id: string }[]) {
      this.checkboxes = {};
      value.forEach((item) => (this.checkboxes[item.id] = false));
      const scrollContainer = this.$refs.scrollContainer as typeof VcContainer;
      scrollContainer?.scrollTop();
    },
  },

  computed: {
    sortDirection() {
      return this.sort?.slice(0, 1) === "-" ? "DESC" : "ASC";
    },

    sortField() {
      return this.sort?.slice(0, 1) === "-" ? this.sort?.slice(1) : this.sort;
    },

    headerCheckbox: {
      get() {
        return Object.values(this.checkboxes).every((value) => value);
      },
      set() {
        const currentState = Object.values(this.checkboxes).every(
          (value) => value
        );
        Object.keys(this.checkboxes).forEach(
          (key) => (this.checkboxes[key] = !currentState)
        );
      },
    },
  },
});
</script>

<style lang="less">
.vc-table {
  border-spacing: 0;
  border-collapse: collapse;
  position: relative;
  padding-top: 43px;

  &-wrapper {
    position: relative;
    overflow: hidden;

    &__inner {
      display: flex;
      position: relative;
      overflow: hidden;
      flex-grow: 1;
    }
  }

  &__header {
    &-cell {
      height: 42px;
      background-color: #f9f9f9;
      border: 0 !important;
      box-shadow: inset 0px 1px 0px #eaedf3, inset 0px -1px 0px #eaedf3;
      box-sizing: border-box;
      position: sticky;
      top: 0;
      user-select: none;

      &_sortable {
        cursor: pointer;
      }
    }
  }

  &__body {
    &-row {
      height: 60px;
      cursor: pointer;
      background-color: #ffffff;

      &_even {
        background-color: #f8f8f8;
      }

      &:hover {
        background-color: #dfeef9;
      }
    }

    &-row:hover &-cell_bordered {
      border-right: 1px solid #bdd1df;
    }

    &-cell {
      box-sizing: border-box;

      &_bordered {
        border-right: 1px solid #eaedf3;
      }
    }
  }

  &__footer {
    background-color: #fbfdfe;
    border-top: 2px solid #eaedf3;
  }

  &__empty {
    &-text {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-medium);
    }
  }
}
</style>
